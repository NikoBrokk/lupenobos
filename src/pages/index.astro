---
import BaseLayout from "../layouts/BaseLayout.astro";
import Header from "../components/Header.astro";
import SectionHeader from "../components/SectionHeader.astro";
import PostCard from "../components/PostCard.astro";
import Footer from "../components/Footer.astro";
import { getCollection } from "astro:content";

const raw = await getCollection("articles");

const safeDate = (d) => {
  const dt = new Date(d);
  return Number.isNaN(dt.valueOf()) ? null : dt;
};

const articles = raw
  .filter((p) => safeDate(p.data.pubDate))
  .sort((a, b) => +safeDate(b.data.pubDate) - +safeDate(a.data.pubDate));

const latest = articles[0];
const rest = articles.slice(1);

const hasCat = (entry, name) => {
  const cats = (entry.data.categories || []).map((c) => String(c).toLowerCase());
  return cats.includes(String(name).toLowerCase());
};

const profiler = rest
  .filter((p) => hasCat(p, "Spillerprofil") || hasCat(p, "Spillerprofiler"))
  .slice(0, 3);

const dyp = rest
  .filter((p) => hasCat(p, "Dypanalyse"))
  .slice(0, 3);

const articleUrlBase = "/articles";
const hrefFor = (entry) => `${articleUrlBase}/${entry.slug}`;

// Hero-bilde: bruk siste cover hvis finnes, ellers fast bilde
const heroImage = latest?.data.cover || "/covers/forside-placeholder.jpg";
---

<BaseLayout>
  <Header />

  <!-- Forsidebilde (Hero) -->
  <section class="hero">
    <img src={heroImage} alt="Forsidebilde Lupen OBOS" class="hero-image" />
    <div class="hero-overlay">
      <h1>Analyse, engasjement og kj√¶rlighet til OBOS-fotballen</h1>
      <p>Dybdeinnsikt i unge OBOS-profiler, kampbildet og ligaens trender</p>
    </div>
  </section>

  <!-- Nyeste artikkel -->
  <SectionHeader kicker="Ferskt" title="Nyeste artikkel" />
  <div class="mx-auto max-w-[var(--container)] px-4 sm:px-6">
    {latest ? (
      <a href={hrefFor(latest)} class="grid md:grid-cols-2 gap-6 card overflow-hidden">
        <div class="aspect-[16/9]">
          <img
            src={latest.data.cover || "/covers/article-placeholder.jpg"}
            alt={latest.data.title}
            class="w-full h-full object-cover"
            loading="lazy"
          />
        </div>
        <div class="p-6">
          <time class="text-xs text-white/60">
            {safeDate(latest.data.pubDate)?.toLocaleDateString("no-NO") ?? ""}
          </time>
          <h3 class="text-2xl font-bold mt-2" style="font-family: 'Space Grotesk', sans-serif;">
            {latest.data.title}
          </h3>
          {latest.data.excerpt && <p class="text-white/80 mt-3">{latest.data.excerpt}</p>}
          <div class="mt-5"><span class="btn btn-primary">Les saken</span></div>
        </div>
      </a>
    ) : (
      <div class="text-white/70">Ingen artikler enda.</div>
    )}
  </div>

  <!-- Spillerprofiler -->
  <SectionHeader kicker="Profiler" title="Spillerprofiler" />
  <div class="mx-auto max-w-[var(--container)] px-4 sm:px-6 grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
    {profiler.map((p) => (
      <PostCard
        href={hrefFor(p)}
        title={p.data.title}
        date={safeDate(p.data.pubDate)?.toLocaleDateString("no-NO") ?? ""}
        excerpt={p.data.excerpt}
        tag="Spillerprofil"
        cover={p.data.cover || "/covers/player-placeholder.jpg"}
      />
    ))}
  </div>

  <!-- Dypanalyse -->
  <SectionHeader kicker="Analyse" title="Dypanalyse" />
  <div class="mx-auto max-w-[var(--container)] px-4 sm:px-6 grid gap-6 sm:grid-cols-2 lg:grid-cols-3 mb-12">
    {dyp.map((p) => (
      <PostCard
        href={hrefFor(p)}
        title={p.data.title}
        date={safeDate(p.data.pubDate)?.toLocaleDateString("no-NO") ?? ""}
        excerpt={p.data.excerpt}
        tag="Analyse"
        cover={p.data.cover || "/covers/analysis-placeholder.jpg"}
      />
    ))}
  </div>

  <Footer />
</BaseLayout>

<style>
.hero {
  position: relative;
  width: 100%;
  height: 400px;
  overflow: hidden;
}
.hero-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.hero-overlay {
  position: absolute;
  bottom: 20px;
  left: 20px;
  color: white;
  text-shadow: 0 2px 5px rgba(0,0,0,0.6);
}
</style>
