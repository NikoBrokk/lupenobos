---
import BaseLayout from "../layouts/BaseLayout.astro";
import Header from "../components/Header.astro";
import Hero from "../components/Hero.astro";
import SectionHeader from "../components/SectionHeader.astro";
import PostCard from "../components/PostCard.astro";
import Footer from "../components/Footer.astro";
import { getCollection } from "astro:content";

// Hent alle artikler fra content collection 'articles'
const raw = await getCollection("articles");

// Trygg dato-parser
const safeDate = (d) => {
  const dt = new Date(d);
  return Number.isNaN(dt.valueOf()) ? null : dt;
};

// Sorter og filtrer bort artikler uten gyldig pubDate
const articles = raw
  .filter((p) => safeDate(p.data.pubDate))
  .sort((a, b) => +safeDate(b.data.pubDate) - +safeDate(a.data.pubDate));

const latest = articles[0];
const rest = articles.slice(1);

// Hjelper for kategori-sjekk (tillater 'Spillerprofil' og 'Spillerprofiler')
const hasCat = (entry, name) => {
  const cats = (entry.data.categories || []).map((c) => String(c).toLowerCase());
  return cats.includes(String(name).toLowerCase());
};

const profiler = rest
  .filter((p) => hasCat(p, "Spillerprofil") || hasCat(p, "Spillerprofiler"))
  .slice(0, 3);

const dyp = rest
  .filter((p) => hasCat(p, "Dypanalyse"))
  .slice(0, 3);

// Sett base-url for artikkelsider (endre til "/artikler" hvis ruten din heter det)
const articleUrlBase = "/articles";
const hrefFor = (entry) => `${articleUrlBase}/${entry.slug}`;
---

<BaseLayout>
  <Header />
  <Hero />

  <!-- Nyeste artikkel -->
  <SectionHeader kicker="Ferskt" title="Nyeste artikkel" />
  <div class="mx-auto max-w-[var(--container)] px-4 sm:px-6">
    {latest ? (
      <a href={hrefFor(latest)} class="grid md:grid-cols-2 gap-6 card overflow-hidden">
        <div class="aspect-[16/9]">
          <img
            src={latest.data.cover || "/covers/placeholder.jpg"}
            alt={latest.data.title}
            class="w-full h-full object-cover"
            loading="lazy"
          />
        </div>
        <div class="p-6">
          <time class="text-xs text-white/60">
            {safeDate(latest.data.pubDate)?.toLocaleDateString("no-NO") ?? ""}
          </time>
          <h3 class="text-2xl font-bold mt-2" style="font-family: 'Space Grotesk', sans-serif;">
            {latest.data.title}
          </h3>
          {latest.data.excerpt && <p class="text-white/80 mt-3">{latest.data.excerpt}</p>}
          <div class="mt-5"><span class="btn btn-primary">Les saken</span></div>
        </div>
      </a>
    ) : (
      <div class="text-white/70">Ingen artikler enda.</div>
    )}
  </div>

  <!-- Spillerprofiler -->
  <SectionHeader kicker="Profiler" title="Spillerprofiler" />
  <div class="mx-auto max-w-[var(--container)] px-4 sm:px-6 grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
    {profiler.map((p) => (
      <PostCard
        href={hrefFor(p)}
        title={p.data.title}
        date={safeDate(p.data.pubDate)?.toLocaleDateString("no-NO") ?? ""}
        excerpt={p.data.excerpt}
        tag="Spillerprofil"
        cover={p.data.cover || "/players/placeholder.jpg"}
      />
    ))}
  </div>

  <!-- Dypanalyse -->
  <SectionHeader kicker="Analyse" title="Dypanalyse" />
  <div class="mx-auto max-w-[var(--container)] px-4 sm:px-6 grid gap-6 sm:grid-cols-2 lg:grid-cols-3 mb-12">
    {dyp.map((p) => (
      <PostCard
        href={hrefFor(p)}
        title={p.data.title}
        date={safeDate(p.data.pubDate)?.toLocaleDateString("no-NO") ?? ""}
        excerpt={p.data.excerpt}
        tag="Analyse"
        cover={p.data.cover || "/covers/placeholder.jpg"}
      />
    ))}
  </div>

  <Footer />
</BaseLayout>
